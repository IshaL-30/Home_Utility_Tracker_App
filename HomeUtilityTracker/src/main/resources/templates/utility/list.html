<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Your Utility Bills</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

<h2>My Utility Bills</h2>
<table class="table table-bordered">
    <thead>
		<tr>
		    <th>Type</th>
		    <th>Amount</th>
		    <th>Due Date</th>
		    <th>Transaction</th>
		    <th>Frequency</th>
		    <th>Status</th>
		    <th>Actions</th> 
		</tr>
    </thead>
    <tbody>
		<tr th:each="bill : ${bills}">
		    <td th:text="${bill.type}"></td>
		    <td th:text="${bill.amount}"></td>
		    <td th:text="${bill.dueDate}" th:style="'color:' + ${dueDateColors[bill.id]}"></td>
		    <td th:text="${bill.transactionType}"></td>
		    <td th:text="${bill.frequencyType}"></td>
			<td>
			    <a th:href="@{'/utilities/toggle-status/' + ${bill.id}}"
			       th:text="${bill.paid ? 'Paid ✅' : 'Unpaid ❌'}"
			       class="btn btn-sm"
			       th:classappend="${bill.paid} ? 'btn-success' : 'btn-warning'">
			    </a>
			</td>
		    <td>
		        <a th:href="@{'/utilities/edit/' + ${bill.id}}" class="btn btn-warning btn-sm">Edit</a>
		        <a th:href="@{'/utilities/delete/' + ${bill.id}}" class="btn btn-danger btn-sm"
		           onclick="return confirm('Are you sure you want to delete this bill?');">Delete</a>
		    </td>
		</tr>
    </tbody>
</table>

<h5 class="mt-4">📊 Bill Category Summary</h5>

<canvas id="billChart" width="100" height="100"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ✅ Thymeleaf JavaScript inlining must be enabled -->
<script th:inline="javascript">
    // Define JS variables using [[...]]
    let fixed = [[${fixedCount}]];
    let recurring = [[${recurringCount}]];

    const ctx = document.getElementById('billChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Fixed', 'Recurring'],
            datasets: [{
                label: 'Bill Categories',
                data: [fixed, recurring],
                backgroundColor: ['#007bff', '#28a745']
            }]
        }
    });
</script>

<div class="mt-4">
    <h5>Total Credited: ₹<span th:text="${creditedTotal}"></span></h5>
    <h5>Total Debited: ₹<span th:text="${debitedTotal}"></span></h5>
    <h4 class="text-success">Net Savings: ₹<span th:text="${savings}"></span></h4>
</div>

<h5>📆 Monthly Summary</h5>
<ul>
  <li th:each="entry : ${monthlyTotals}">
    <span th:text="${entry.key} + ': ₹' + ${entry.value}"></span>
  </li>
</ul>

<h5>📅 Yearly Summary</h5>
<ul>
  <li th:each="entry : ${yearlyTotals}">
    <span th:text="${entry.key} + ': ₹' + ${entry.value}"></span>
  </li>
</ul>


<a href="/utilities/add" class="btn btn-success">Add Another Bill</a>

<div class="mb-3">
    <a class="btn btn-outline-primary" th:href="@{/utilities/list}">All</a>
    <a class="btn btn-outline-secondary" th:href="@{/utilities/filter(category='FIXED')}">Fixed</a>
    <a class="btn btn-outline-success" th:href="@{/utilities/filter(category='RECURRING')}">Recurring</a>
</div>

<h5 class="mt-5">📊 Monthly Spending Summary</h5>
<canvas id="monthlyChart" width="500" height="200"></canvas>

<script th:inline="javascript">
    // Extract keys (months) and values (totals) from the Thymeleaf map
    let monthLabels = [[${monthlyTotals.keySet()}]];
    let monthData = [[${monthlyTotals.values()}]];

    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Monthly Spending (₹)',
                data: monthData,
                backgroundColor: '#17a2b8'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
</body>
</html>
